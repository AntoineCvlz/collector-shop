on:
  workflow_call:
    secrets:
      SEMGREP_APP_TOKEN:
        required: false

permissions:
  security-events: write
  contents: read
  actions: read

jobs:
  code-quality-sast:
    name: Security Scan (Laravel)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 1. SEMGREP (Remplace avantageusement CodeQL pour PHP)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          # On utilise des rÃ¨gles spÃ©cifiques Ã  PHP et Laravel
          config: >-
            p/php
            p/laravel
            p/owasp-top-10
            p/security-audit
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: ğŸ“¤ Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('semgrep.sarif') != ''
        with:
          sarif_file: semgrep.sarif
          category: semgrep

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 2. COMPOSER AUDIT (SÃ©curitÃ© des dÃ©pendances)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¦ Check PHP Dependencies Security
        run: |
          cd backend
          composer audit
        continue-on-error: true

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 3. LARAVEL PINT (QualitÃ© de code / Linter)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ¨ Check Code Style (Pint)
        run: |
          cd backend
          # On utilise --test pour ne pas modifier les fichiers mais juste vÃ©rifier
          ./vendor/bin/pint --test
        continue-on-error: true